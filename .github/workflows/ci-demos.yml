name: demos

on:
  push:
    branches: [ develop, main ]
    paths-ignore:
      - 'docs/**'
  pull_request:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test:
    name: Tests on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: [3.11, 3.12]
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel pytest
          python -m pip install scikit-build-core cmake ninja pybind11 numpy
          python -m pip install dtcc-pyspade-native
          python -m pip install --no-build-isolation .

      - name: Download cached demo data (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p ~/.cache
          curl -L -o dtcc-demo-data-cache.zip \
            "https://github.com/dtcc-platform/dtcc-data/releases/download/cache-v1/dtcc-demo-data-cache.zip"
          unzip -q dtcc-demo-data-cache.zip -d ~/.cache/
          mv ~/.cache/dtcc-data-demo-cache ~/.cache/dtcc-data
          rm dtcc-demo-data-cache.zip
          echo "Cache contents:"
          ls -la ~/.cache/dtcc-data/
      
      - name: Download cached demo data (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p ~/Library/Caches
          curl -L -o dtcc-demo-data-cache.zip \
            "https://github.com/dtcc-platform/dtcc-data/releases/download/cache-v1/dtcc-demo-data-cache.zip"
          unzip -q dtcc-demo-data-cache.zip -d ~/Library/Caches/
          mv ~/Library/Caches/dtcc-data-demo-cache ~/Library/Caches/dtcc-data
          rm dtcc-demo-data-cache.zip
          echo "Cache contents:"
          ls -la ~/Library/Caches/dtcc-data/
      
      - name: Download cached demo data (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:LOCALAPPDATA\dtcc-data\dtcc-data\Cache"
          Invoke-WebRequest -Uri "https://github.com/dtcc-platform/dtcc-data/releases/download/cache-v1/dtcc-demo-data-cache.zip" -OutFile dtcc-demo-data-cache.zip
          Expand-Archive -Path dtcc-demo-data-cache.zip -DestinationPath "$env:TEMP"
          Copy-Item -Path "$env:TEMP\dtcc-data-demo-cache\*" -Destination "$env:LOCALAPPDATA\dtcc-data\dtcc-data\Cache" -Recurse
          Remove-Item dtcc-demo-data-cache.zip
          Remove-Item -Recurse "$env:TEMP\dtcc-data-demo-cache"
          Write-Host "Cache contents:"
          Get-ChildItem "$env:LOCALAPPDATA\dtcc-data\dtcc-data\Cache"

      - name: Run demos on Non-Windows
        if: matrix.os != 'windows-latest'
        run: |
          for file in demos/*.py; do
            if [ "$file" = "demos/download_data.py" ]; then
              echo "Skipping $file"
              continue
            fi
            
            if [ "$file" = "demos/build_city_volume_mesh.py" ]; then
              echo "Skipping $file"
              continue
            fi

            if [ "$file" = "demos/build_dem.py" ]; then
              echo "Skipping $file"
              continue
            fi

            echo "Running $file"
            python "$file"
          done

      - name: Run demos on Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Push-Location demos
          $files = Get-ChildItem *.py
          foreach ($file in $files) {
            if ($file.Name -eq 'download_data.py') {
              Write-Host "Skipping $($file.Name)"
              continue
            }
            if ($file.Name -eq 'build_city_volume_mesh.py') {
              Write-Host "Skipping $($file.Name)"
              continue
            }
            if ($file.Name -eq 'build_dem.py') {
              Write-Host "Skipping $($file.Name)"
              continue
            }
            Write-Host "Running $($file.Name)"
            python $($file.Name)
          }
          Pop-Location

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Slack notification on success
        if: ${{ needs.test.result == 'success' }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          REPO_NAME="${{ github.repository }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"✅ *SUCCESS*\\nRepository: \`${REPO_NAME}\`\\nCommit: \`${SHORT_SHA}\`\\nAuthor: ${COMMIT_AUTHOR}\\nMessage: ${COMMIT_MESSAGE}\"
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL_GITHUB }}

      - name: Slack notification on failure
        if: ${{ needs.test.result == 'failure' }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          REPO_NAME="${{ github.repository }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"❌ *FAILURE*\\nRepository: \`${REPO_NAME}\`\\nCommit: \`${SHORT_SHA}\`\\nAuthor: ${COMMIT_AUTHOR}\\nMessage: ${COMMIT_MESSAGE}\"
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL_DEVELOPMENT }}